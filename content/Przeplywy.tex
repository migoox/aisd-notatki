\subsection{Wstęp}
\begin{defi}
	Sieć przepływowa to graf skierowany $G$
	z funkcją wag $c: E(G) \to 
	\mathbb{R}_{\geq 0} \cup \{\infty\}$ oraz
	wyróżnionymi wierzchołkami $s$ i $t$. Mówimy, że
	\begin{itemize}
		\item $c(e)$ to przepustowość krawędzi $e \in E(G)$,
		\item $s$ to źródło (ang. source),
		\item $t$ to ujście (ang. target).
	\end{itemize}
\end{defi}

\begin{defi}
	Przepływem nazywamy funkcję $f: E(G) \to \mathbb{R}_{\geq 0}$ 
	taką, że 
	\begin{itemize}
		\item $f(e) \leq c(e)$ dla każdej krawędzi $e\in E(G)$,
		\item $f^+(v) = f^-(v)$ dla każdego wierzchołka $v \in V(G) \setminus \{s, t\}$,
	\end{itemize}
	gdzie $f^+(v) := \sum\limits_{u:vu \in E(G)} f(vu)$ oraz $f^-(v) := \sum\limits_{u:uv \in E(G)} f(uv)$,
	tak samo jeśli $S \subset V(G)$, to $f^+(S) := \sum\limits_{uv \in E(G), u\in S \land v \not \in S  } f(uv)$ oraz 
	$f^-(S) := \sum\limits_{uv \in E(G), u\not \in S \land v \in S  } f(uv)$
\end{defi}

\begin{defi}
	Wartością przepływu nazywamy różnicę 
	$\text{val}(f)=f^+(s)-f^-(s)$.
\end{defi}

\subsection{Problem maksymalnego przepływu}
Dana jest sieć przepływowa $(G, c, s, t)$ szukamy przepływu $f$
o maksymalnej możliwej wartości $\text{val}(f)$. 

\begin{defi}
	Sieć rezydualna dla danej sieci przepływowej $(G, c, s, t)$
	oraz przepływu $f$ to graf skierowany $R$ o zbiorze
	wierzchołków $V(G)$, funkcji $c_f$ oraz zbiorze krawędzi
	równym $\{uv : c_f(uv) > 0\}$, gdzie funkcja $c_f$ jest 
	zdefiniowana następująco
	\begin{itemize}
		\item $c_f(uw) = c(uw) - f(uw)$, gdy $uw \in E(G)$ oraz $wu \not \in E(G)$ (krawędź w przód)
		\item $c_f(uw) = f(wu)$, gdy $uw \not \in E(G)$ oraz $wu \in E(G)$ (krawędź wstecz)
		\item $c_f(uw) = c(uw) - f(uw) + f(wu)$, gdy 
		$uw \in E(G)$ oraz $wu \in E(G)$
	\end{itemize}
\end{defi}

Intuicyjnie $c_f(uw)$ możemy
rozumieć jako określenie ile jednostek przepływu 
jesteśmy w stanie "przepuścić" z $u$ do $w$, co
możemy osiągnąć albo zwiększając przepływ na krawędzi $uw$
albo zmniejszając przepływ na krawędzi $wu$.

Warto zauważyć, że w sieci rezydualnej rozpatrujemy tylko te 
krawędzie, dla których przepustowość rezydualna jest większa niż 0.

\begin{defi}
	Ścieżką powiększającą nazywamy dowolną ściężką od $s$
	do $t$ w sieci rezydualnej. 
\end{defi}

Zauważmy, że jeśli znajdziemy ścieżkę powiększającą $P$ 
w sieci rezydualnej,
to wartość przepływu $f$ jesteśmy w stanie powiększyć o 
$\min\limits_{uw \in E(P)} \{c_f(uw)\}$.

\subsubsection{Algorytm Forda-Fulkersona}

\begin{algorithm}[H]
	\caption{Algorytm Forda-Fulkersona}\label{ford-fulker_alg}
	\begin{algorithmic}[1]
		\Procedure{FordFulkerson($G, w$, $s$, $t$)}{}
		\State Niech $f$ to zerowy przepływ w sieci $(G,c,s,t)$
		\State Utwórz sieć rezydualną $(R, c_f)$ dla wejściowej 
		sieci przepływowej oraz dla $f$ 
		\While{Istnieje ścieżka powiększająca $P$ w $R$}
		\State Oznaczmy $P = v_1v_2\dots v_k$ (gdzie $v_1 = s$ oraz $v_k = t$)
		\State $a \gets \min_{i \in \{1, 2, \dots, k-1\}} r(v_iv_{i+1})$
		\State Powiększ $f$ o $a$ na wszystkich krawędziach $P$
		\State Uaktualnij $(R, c_f)$ na wszystkich krawędziach $P$
		\EndWhile
		\State \Return $f$
		\EndProcedure
	\end{algorithmic}
\end{algorithm}

\begin{theorem}
	(Twierdzenie Forda-Fulkersona) Przepływ ma maksymalną wartość wtedy i tylko 
	wtedy, gdy nie istnieje ścieżka powiększająca.
	\begin{proof}
		MD2
	\end{proof}
\end{theorem}

Uwaga: zwykle 
zakładamy, że przepustowości krawędzi są liczbami całkowitymi, 
ponieważ, wówczas po każdym 
wykonaniu pętli while, wartość przepływu $f$ zwiększy się
przynajmniej o 1, co umożliwia oszacowanie
złożoności algorytmu. 

Możemy oszacować, że algorytm Forda-Flukersona 
zakończy się w czasie $O(mf_{\max})$, gdzie 
przez $f_{\max}$ oznaczamy wartość maksymalnego przepływu. 
Z tego oszacowania wnioskujemy, że dla sieci, w których
maksymalna wartość przepływu jest duża, 
nie warto stosować tego algorytmu. 

\subsubsection{Algorytm Edmondsa-Karpa}
Algorytm Edmondsa-Karpa różni się od 
algorytmu Forda-Fulkersona tylko tym, że
w pętli while operujemy na najkrótszej ścieżce powiększającej
zamiast na dowolnej.

Okazuje, się że taka modyfikacja daje nam gwarancję, że
algorytm zakończy się w czasie wielomianowym.

\begin{algorithm}[H]
	\caption{Edmonds-Karp}\label{edmonds-karp_alg}
	\begin{algorithmic}[1]
		\Procedure{EdmondsKarp($G, w$, $s$, $t$))}{}
		\State Niech $f$ to zerowy przepływ w sieci $(G,c,s,t)$
		\State Utwórz sieć rezydualną $(R, c_f)$ dla wejściowej 
		sieci przepływowej oraz dla $f$ 
		\While{Istnieje ścieżka powiększająca w $R$}
		\State Niech $P = v_1v_2\dots v_k$ będzie \textbf{najkrótszą}
		ścieżką powiększająca (gdzie $v_1 = s$ oraz $v_k = t$)
		\State $a \gets \min_{i \in \{1, 2, \dots, k-1\}} r(v_iv_{i+1})$
		\State Powiększ $f$ o $a$ na wszystkich krawędziach $P$
		\State Uaktualnij $(R, c_f)$ na wszystkich krawędziach $P$
		\EndWhile
		\State \Return $f$
		\EndProcedure
	\end{algorithmic}
\end{algorithm}


\begin{theorem}
	Algorytm Edmondsa-Karpa dla zadanej sieci przepływowej $(G, c, s, t)$
	zakończy się w czasie $O(nm^2)$, gdzie $n$ i $m$ to dopowiednio
	liczba wierzchołków i liczba krawędzi grafu skierowanego $G$.
	\begin{proof}
		Dla dowolnego przepływu $f$ w sieci $(G, c, s, t)$ i wierzchołków
		$u, v \in V(G)$ przez $d_f(u, v)$, będziemy oznaczali najmniejszą
		możliwą liczbę krawędzi na $u$-$v$-ścieżce w sieci 
		rezydualnej odpowiadającej przepływowi $f$ (inaczej: odległość
		od $u$ do $v$ w sensie liczby krawędzi w sieci rezydualnej dla $f$).
		
		Niech $P_1, P_2, \dots P_k$ to wszystkie najkrótsze
		$s$-$v$-ścieżki w sieci rezydualnej odpowiadającej przepływowi
		$f$, wtedy 
		\[L_f := |\bigcup_{i \in [k]} E(P_i)|.\]
		
		\textbf{Stwierdzenie 1:} Niech $f$ będzie przepływem przed
		pewną iteracją pętli w linii nr. 4, a $f'$ przepływem 
		po tej iteracji. Wówczas
		dla każdego $v$ zachodzi $d_{f'}(s, v) \geq d_{f}(s,v)$,
		
		\textbf{Dowód stwierdzenia 1:}
		Przypuśćmy, że tak nie jest, tzn., że istnieje 
		taki wierzchołek $v \in V(G)$, że $d_{f'}(s, v) < d_f(s,v)$.
		Bez straty ogólności przyjmijmy, że $v$
		minimalizuje $d_{f'}(s,v)$ spośród takich problematycznych 
		wierzchołków - tzn., że dla każdego wierzchołka $x$, dla 
		którego $d_{f'}(s, x) < d_{f'}(s, v)$ prawdą jest, że 
		$d_{f'}(s, x) \geq d_f(s,x)$.
		
		Niech $P'$ to najkrótsza w sensie liczby krawędzi $s$-$v$-ścieżka
		w sieci rezydualnej odpowiadającej $f'$. Przez $w$ oznaczmy 
		przedostatni wierzchołek na ścieżce $P'$. Rozpatrzmy
		teraz dwa przypadki:
		\begin{itemize}
			\item[1.] Krawędź $wv$ należy do sieci rezydualnej 
			odpowiadającej
			przepływowi $f$, tzn. $c_f(wv) > 0$. W takiej 
			sytuacji możemy zapisać, że  
			\[d_f(s, v) \leq d_f(s, w) + 1 \leq d_{f'}(s, w) + 1 = d_{f'}(s, v),\]
			gdzie pierwsza nierówność wynika z faktu, że sieć rezydualna $f$
			ma krawędź od $w$ do $v$, druga z minimalności $v$ (tzn. 
			$w$ znajduje się bliżej źródła niż $v$), a ostatnia równość
			wynika stąd, że $w$ poprzeda $v$ na najkrótszej ścieżce 
			w sieci rezydualnej dla $f'$ (z doboru $P'$).
			Powyższy ciąg nierówności stoi w sprzeczności z
			$d_{f'}(s, v) < d_f(s,v)$.
			
			\item[2.] Krawędź $wv$ nie należy do sieci rezydualnej 
			odpowiadającej
			przepływowi $f$, tzn. $c_f(wv) = 0 \Rightarrow c(wv) = f(wv)$.
			Skoro  $c_{f'}(wv) > 0$, to oznacza, że przepływ na
			krawędzi $wv$ podczas wykonywania się iteracji zmienił się, 
			co w połączeniu z faktem, że  $c_f(wv) = 0$
			implikuje, że krawędź $vw$ musiała być częścią ścieżki 
			powiększającej wybranej w linii nr. 5 w tej iteracji.
			Zatem 
			\[d_f(s, w) = d_f(s, v) + 1,\]
			co doprowadza nas do 
			\[d_f(s, v) = d_f(s,w) - 1 \leq
			d_{f'}(s,w) -1 = d_{f'}(s,v    ) - 2 < d_{f'}(s,v)\]
			Powyższy ciąg nierówności stoi w sprzeczności z
			$d_{f'}(s, v) < d_f(s,v)$.
		\end{itemize}
		
		Zatem stwierdzenie 1 jest prawdziwe.
		
		\textbf{Stwierdzenie 2:} Niech $f$ będzie przepływem przed
		pewną iteracją pętli w linii nr. 4, a $f'$ przepływem 
		po tej iteracji. Wówczas 
		jeżeli $d_{f'}(s, t) = d_f(s,t)$, to $L_{f'} < L_f$.
		
		\textbf{Dowód stwierdzenia 2:} Najpierw pokażemy, że
		każda krawędź licząca się do $L_{f'}$, musi zaliczać się
		również do $L_f$. W tym celu rozważmy pewną najkrótszą (względem
		liczby krawędzi) ścieżkę $P' = \omega_0 \omega_1 \dots \omega_k$,
		w sieci rezydualnej dla $f'$,
		gdzie $s = \omega_0$, $t = \omega_k$ oraz $k = d_{f'}(s, t)$.
		Rozważmy odległości kolejnych wierzchołków na ścieżce 
		od $s$ w sieci rezydualnej dla $f$. 
		
		Rozważmy dwa przypadki dla krawędzi $\omega_i \omega_{i+1}$:
		\begin{itemize}
			\item[1.] Krawędź $\omega_i \omega_{i+1}$ była obecna w sieci rezydualnej
			dla przepływu $f$, wtedy musi zachodzić 
			\[d_f(\omega_{i+1}) \leq d_f(\omega_{i}) + 1.\]
			\item[2.] Krawędź $\omega_i \omega_{i+1}$ nie była obecna w sieci rezydualnej
			dla przepływu $f$, wtedy musi zachodzić
			\[d_f(\omega_{i+1}) \leq d_f(\omega_{i}) - 1,\]
			ponieważ krawędź $\omega_i \omega_{i+1}$ została dodana
			do sieci rezydualnej $f'$ wskutek powiększenia przepływu
			wzdłuż ścieżki $P$ wybranej w linii nr. 5.
		\end{itemize}
		
		Kumulując powyższe przypadki, otrzymamy
		\[d_{f}(s, t) \leq d_{f}(s, \omega_{k-1}) \pm 1 \leq
		(d_{f}(s, \omega_{k-2}) \pm 1) \pm 1 \leq \ldots \leq A - B,\]
		gdzie $A$ oznacza liczbę wystąpień przypadku 1., z kolei
		$B$ - liczbę wystąpień przypadku 2. Ale z założenia 
		$d_{f'}(s,t)=d_f(s,t)$, więc ścieżka $P'$ ma dokładnie $d_f(s,t)$
		krawędzi, co pociąga za sobą $B = 0$ (bo wyrażenie
		$A-B$ jest maksymalnie równe $d_f(s,t)$), z czego wynika, 
		że żadna z krawędzi 
		ścieżki $P'$ nie może realizować przypadku 2. Z tego 
		rozumowania wynika, że każda krawędź na ścieżce $P'$
		znajdowała się w sieci rezydualnej dla $f$. Z dowolności wyboru
		$P'$ każda krawędź licząca się do $L_{f}$ musi też zaliczać się
		do $L_{f'}$, co chcieliśmy pokazać.
		
		Teraz zauważmy, że przynajmniej jedna krawędź wliczająca
		się do $L_f$ nie wlicza się do $L_{f'}$, jest to krawędź 
		o przepustowości $a$ (linijka nr. 6), która znajduje się
		na ścieżce $P$ wybranej w linii nr. 5. Zatem ostatecznie 
		\[L_{f'} < L_f,\]
		a więc dowód stwierdzenia 2. jest kompletny.
		
		Z obu powyższych stwierdzeń możemy wywnioskować, dwa przypadki
		\begin{itemize}
			\item[1.] $d_{f'}(s, t) > d_f(s, t)$,
			\item[2.] $d_{f'}(s, t) = d_f(s, t) \Rightarrow 
			L_{f'} < L_f$.
		\end{itemize}
		Oba powyższe przypadki implikują, że z sieci rezydualnej została 
		usunięta co najmniej jedna krawędź, co pozwala nam 
		dokonać oszacowania.
		
		W pesymistycznym przypadku mamy $n-1$ $s$-$t$-ścieżek oraz 
		pesymistycznie usuwamy dokładnie jedną krawędź w każdej iteracji
		co ostatecznie daje nam nie więcej niż $nm$ wywołań pętli w nr. 4.
		Ponadto w każdej iteracji wywołujemy BFS w celu znalezienia najkrótszej
		ścieżki, z kosztem $O(m)$. Zatem złożoność algorytmu Edmondsa-Karpa
		to $O(nm^2)$.
		
	\end{proof}
\end{theorem}

\subsubsection{Algorytm Dinic'a}
Za pomocą algorytmu Edmondsa-Karpa udało się uzyskać złożoność 
pesymistyczną $O(nm^2)$. Zauważmy jednak, że każde wywołanie 
BFS w celu znalezienia najkrótszej względem liczby krawędzi 
$s$-$t$-ściezki w sieci rezydualnej $R$, skutkuje znalezieniem 
wszystkich najkrótszych $s$-$t$-ścieżek, pomimo tego algorytm
Edmondsa-Karpa nasyca tylko jedną z nich, co oznacza, że
BFS może zostać wywołany w celu znalezienia ścieżek,
które były już wcześniej znalezione.

Algorytm Dinic'a po każdym wywołaniu BFS, nasyca wszystkie możliwe najkrótsze ścieżki a nie tylko jedną
tak jak w przypadku algorytmu Edmondsa-Karpa, co pozwala na 
osiągnięcie złożoności pesymistycznej $O(n^2m)$. Przepływ w $R$, który nasyca każdą taką ścieżkę
będziemy nazywali \textit{przepływem blokującym}.

\begin{defi}[Przepływ blokujący]
	Niech $R$ będzie siecią rezydualną dla pewnej sieci przepływowej
	$(G, c, s, t)$ oraz przepływu $f$. Niech $d$ będzie odległością w sensie
	liczby krawędzi od $s$ do $t$ w $R$.
	
	Przez przepływ blokujący w $R$ rozumiemy przepływ $b$ w sieci
	$(R, c_f, s, t)$, taki, że każda ścieżka od $s$ do $t$ 
	w $b$ ma dokładnie $d$ krawędzi oraz dla każdej ścieżki o $d$ 
	krawędziach od $s$ do $t$ w $R$, przynajmniej jedna krawędź tej ścieżki
	jest nasycona przez $b$.
\end{defi}

\begin{algorithm}[H]
	\caption{Algorytm Dinic'a}
	\begin{algorithmic}[1]
		\Procedure{Dinic($G, w$, $s$, $t$)}{}
		\State Niech $f$ to zerowy przepływ w sieci $(G,c,s,t)$
		\State Utwórz sieć rezydualną $(R, c_f)$ dla wejściowej 
		sieci przepływowej oraz dla $f$ 
		\While{Istnieje ścieżka powiększająca w $R$}
		\State Znajdź przepływ blokujący $b$ w sieci $(R, c_f, s, t)$
		\State Powiększ $f$ o $b$
		\State Uaktualnij $(R, c_f)$
		\EndWhile
		\State \Return $f$
		\EndProcedure
	\end{algorithmic}
	\label{dinic_alg}
\end{algorithm}

Aby powyższy algorytm był kompletny, musimy jeszcze pokazać jak znaleźć przepływ blokujący.

Wprowadźmy pojęcie \textit{sieci warstwowej}, która będzie
oznaczała drzewo najkrótszych ścieżek.
\begin{defi}[Sieć warstwowa]
	Siecią warstwową $\overline{R}$ dla sieci rezydualnej $R$
	definiujemy jako graf skierowany $\overline{R} = (V(R), \overline{E})$, gdzie
	\[\overline{E}=\{uv : uv \in E(R) \land \text{dist}(s, u)  + 1 = \text{dist}(s, v)\}.\]
\end{defi}

Znajdowanie przepływu blokującego odbywa się w dwóch etapach -- najpierw
wywołujemy BFS w celu znalezienia sieci warstwowej,
a następnie korzystając z wywołania DFS, konstruujemy
przepływ blokujący.

\begin{algorithm}[H]
	\caption{Znajdowanie przepływu blokującego}
	\begin{algorithmic}[1]
		\Procedure{FindBlockingFlow($R, c_f, s, t$)}{}
		\State $\overline{R} \gets$ FindLayerGraph($R$, $c_f$, $s$, $t$)
		\State Niech $b$ to zerowy przepływ w sieci $(R, c_f, s, t)$
		\State Niech Min to tablica o $|V(\overline{R})|$ elementach, 
		dla każdego wierzchołka $v$ przechowywana będzie liczba całkowita,
		oznaczająca ile jednostek możemy przesłać $s$-$v$-ścieżką 
		\State Min$[s] = \infty$
		\State Niech Visited to tablica booli o $|V(\overline{R})|$ elementach
		\State Niech $P$ oznacza aktualną ścieżkę
		\Procedure{EdgeDFS}{$u$, $v$}
		\State Min = $\min\{c_f(uv) - b(uv), \text{Min}[u]\}$
		\If{$v = t$}
		\For{$xy \in P$}
		\State $b(xy) = b(xy) + \text{Min}[t]$
		\State $\text{Min}[x] = \text{Min}[x] - \text{Min}[t]$
		\EndFor
		\EndIf
		\For{$x \in N(v)$}
		\If{Visited$[x]=$ \textit{false}}
		\State Visited$[x]=$ \textit{true} 
		\State $P$.PushBack($v$)
		\State EdgeDFS($v$, $x$)
		\State $P$.PopBack()
		\EndIf
		\EndFor
		\EndProcedure
		\For{$v \in N(s)$}
		\State EdgeDFS($s$, $v$)
		\EndFor
		\State \Return $b$
		\EndProcedure
	\end{algorithmic}
	\label{layer_graph_alg}
\end{algorithm}

\subsection{Problem MinCostMaxFlow}
\textbf{Dane:}
\begin{itemize}
	\item Sieć przepływowa $(G, c, s, t)$
	\item Funkcja kosztu $k : E(G) \to \mathbb{R}$
\end{itemize}

\textbf{Szukane:}
Maksymalny przepływ $f$, który minimalizuje koszt 
\[k(f) := \sum_{e\in E(G)}k(e)f(e).\]

Ten problem możemy rozumieć jako wybranie takiego przepływu $f$ 
ze wszystkich maksymalnych przepływów, dla którego
$k(f)$ jest najmniejsze. 

\begin{defi}
	Siecią rezydualną z kosztami dla danej sieci przepływowej
	$(G, c, s, t)$, funkcji kosztów $k$ i przepływu $f$ nazywamy
	graf skierowany $R$ o zbiorze wierzchołków $V(G)$, funkcji
	wag $c_f$, funkcji kosztów $k_f$ oraz zbiorze 
	krawędzi równym $\{ uv: c_f(uv) > 0\}$, gdzie funkcje 
	$c_f$ i $k_f$ są zdefiniowane następująco:
	\begin{itemize}
		\item $c_f(uw) = c(uw) - f(uw)$ i $k_f(uw) = k(uw)$,
		jeśli $uw \in E(G)$ oraz $wu \not \in E(G)$
		\item $c_f(uw) = f(uw)$ i $k_f(uw) = -k(uw)$,
		jeśli $uw \not \in E(G)$ oraz $wu \in E(G)$
	\end{itemize} 
\end{defi}
W powyższej definicji nie uwzględniamy przypadku kiedy 
$uw \in E(G)$ oraz $wu \in E(G)$, ponieważ w takiej sytuacji
sieć rezydualna jest multigrafem, który utrudnia reprezentację. 
Jako, że taką sytuację można łatwo rozwiązać tworząć podpodział
krawędzi $uw$ lub $wu$, przyjmujemy, że operujemy na grafach,
w których takie sytuacje nie występują.

\begin{theorem}
	(Twierdzenie o minimalnym koszcie) Niech $f$ będzie
	maksymalnym przepływem w sieci $(G, c, s, t)$ z funkcją 
	kosztu $k$. Wówczas $f$ jest maksymalnym przepływem 
	o minimalnym koszcie wtedy i tylko wtedy, gdy 
	odpowiadająca mu sieć rezydualna z kosztami
	nie zawiera cyklu o ujemnym koszcie.
	\begin{proof}
		Przez $(R_f, c_f, k_f)$, będziemy oznaczali sieć rezydualną
		z kosztami odpowiadającą przepływowi $f$, gdzie $c_f$ 
		jest funkcją przepustowości, a $k_f$ funkcją kosztów.
		Zauważmy, że $(R_f, c_f)$ oraz $(R_f, k_f)$ są ważonymi 
		grafami skierowanymi.
		
		Najpierw pokażemy, że jeśli $(R_f, k_f)$ zawiera ujemny cykl,
		to maksymalny przepływ $f$ nie minimalnego kosztu.
		Niech $C$ będzie ujemnym cyklem w $(R_f, k_f)$, tzn. $k_f(C) < 0$.
		Niech $a$ to najmniejsza przepustowość w $(R_f, c_f, k_f)$, pewnej
		krawędzi na $C$, tzn.
		\[a := \min_{uw \in C} c_f(uw) > 0,\]
		gdzie nierówność wynika z definicji sieci rezydualnej. Rozważmy 
		przepływ $f'$, taki, że, dla każdego
		$e \in E(G)$
		\[f'(e) = \begin{cases} 
			f(e) + a, \text{jeśli } e \in C \\
			f(e), \text{jeśli } e \not \in C 
		\end{cases}\]
		Zauważmy, że wartość przepływu $f'$ jest taka sama
		jak wartość przepływu $f$, zatem $f'$ również jest
		maksymalnym przepływem. Ponadto zachodzi 
		\[k(f') = k(f) + ak_f(C),\]
		skoro $k_f(C)$ jest ujemne, to 
		\[k(f') > k(f),\]
		czyli znaleźliśmy inny przepływ maksymalny o mniejszym koszcie
		co kończy tę część dowodu.
		
		Pokażemy teraz, że jeśli maksymalny przepływ $f$
		nie jest minimalnego kosztu, to w $(R_f, k_f)$ musi istnieć
		ujemny cykl. Rozważmy przepływ $f'$, który jest
		maksymalnym przepływem o minimalnym koszcie różniącym
		się od $f$ na najmniejszej możliwej liczbie krawędzi tzn.
		dla każdego maksymalnego przepływu $f''$ prawdą jest, że
		\[|\{e \in E(G) : f'(e) \not = f(e)\}| \leq 
		|\{e \in E(G) : f''(e) \not = f(e)\}|.\]
		Niech $S$ będzie zbiorem krawędzi sieci rezydualnej dla $f$ 
		takich, że przepuszczenie dodatkowego (dodatniego)
		przepływu wzdłuż tych krawędzi przybliży $f$ do $f'$, tzn.
		\[S = \{uw : f(uw) < f'(uw) \lor f(wu) > f'(wu)\}.\]
		Przez $S'$ oznaczmy krawędzie sieci rezydualnej dla $f'$
		odwrotne do $S$.
		
		Zauważmy, że wartości przepływów $f$ i $f'$ są równe (bo oba są
		maksymalnymi przepływami), a więc dla każdego wierzchołka
		$v \in V(G)$ otrzymujemy
		\[f^+(v) - f^-(v) = f^{'+}(v) - f^{'-}(v),\]
		bo dla $v \in \{s, t\}$ otrzymujemy po obu 
		stronach wartość przepływu, która jest taka sama, a
		dla  $v \not \in \{s, t\}$ otrzymujemy zero z definicji przepływu.
		Przekształcając tę równość otrzymujemy
		\[f^{'+}(v) - f^+(v) = f^{'-}(v) - f^{-}(v),\]
		więc jeśli do $v$ wchodzi jakaś krawędź z $S$, to 
		z powyższej równości oraz definicji $S$ wynika, że
		musi z niego wychodzić jakaś krawędź z $S$. Jako, że
		liczba wierzchołków jest skończona powyższy fakt musi 
		pociągać za sobą istnienie cyklu wewnątrz zbioru $S$ (bo
		nie możemy wychodzić
		do nieodwiedzonego wierzchołka w nieskończoność).
		
		Niech $C$ będzie cyklem w $S$, a więc również 
		cyklem w sieci rezydualnej $f$; przez $C'$ oznaczmy
		odwrotność cyklu $C$, tzn. $C' := \{wu : uw \in C\}$.
		Zauważmy, że $C'$ jest cyklem w $S'$, a więc jest
		również cyklem w sieci rezydualnej $f'$. 
		
		Ponadto oznaczmy
		przez $a$ najmniejszą wartość z $f'(uw) - f(uw)$ po krawędziach
		$uw \in C$ spełniających $f(uw) < f'(uw)$ oraz z 
		$f(wu) - f'(wu)$ po krawędziach $wu \in C$ spełniających
		$f(wu) > f'(wu)$. Intuicyjnie, $a$ jest taką wartościa, 
		że
		możemy powiększyć przepływ $f$ wzdłuż cyklu $C$ o $a$ 
		nie przekraczając przepustowości krawędzi oraz 
		takie powiększenie
		spowoduje, że któraś z krawędzi $C$ przestanie 
		„zaliczać się” do zbioru $S$.
		
		Zauważmy, że gdyby $k_f(C) > 0$ , wówczas $k_{f'}(C) < 0$
		co jest sprzeczne, bo $f'$ jest maksymalnym
		przepływem o minimalnym koszcie a już pokazaliśmy,
		że to implikuje brak ujemnych cykli
		w sieci rezydualnej z kosztem.
		
		W przypadku kiedy $k_f(C) = 0$ to oznaczałoby że $k_{f'}(C)=0$,
		a więc przepływ $f'' := f' + aC'$, czyli przepływ otrzymany
		z $f'$ poprzez powiększenie wzdłuż cyklu $C'$ o $a$ również 
		jest maksymalnym przepływem o minimalnym koszcie, jednakże
		ze sposobu wyboru $a$ wynika, że $f''$ różni się od $f$
		na mniejszej liczbie krawędzi niż $f'$, co stoi w 
		sprzeczności ze sposobem wyboru $f'$.
		
		Oznacza to, że $k_f(C) > 0$ co kończy dowód.
		
	\end{proof}
	\label{mincost_maxflow_proof}
\end{theorem}

\begin{algorithm}[H]
	\caption{Algorytm ,,Przez usuwanie cykli''}
	\begin{algorithmic}[1]
		\Procedure{CycleCanceling(($G, c$, $s$, $t$), $k$)}{}
		\State $f \gets $ maksymalny przepływ dla $(G,c,s,t)$
		\State $(R,c_f,k_f) \gets (G,c,k)$ (sieć rezydualna dla $f$)
		\While{Istnieje ujemny cykl $C$ w $(R, k_f)$}
		\State $a \gets \min\{c_f(uw) : uw \in C\}$
		\State Powiększ $f$ o $a$ na wszystkich krawędziach $C$
		\State Uaktualnij $(R, c_f, k_f)$ na wszystkich krawędziach $C$
		\EndWhile 
		\State \Return $f$
		\EndProcedure
	\end{algorithmic}
	\label{zad45}
\end{algorithm}
